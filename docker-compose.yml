version: '3.8'

# Environment variables dosyasÄ±ndan deÄŸerleri al
# .env dosyasÄ± oluÅŸturun: cp ENV_TEMPLATE.txt .env
# Sonra .env dosyasÄ±ndaki deÄŸerleri doldurun

# ðŸš€ OPTIMIZED VERSION - 27 â†’ 13 Container
# - Tek PostgreSQL database (schema bazlÄ±)
# - Kafka + Zookeeper kaldÄ±rÄ±ldÄ±
# - Meilisearch kaldÄ±rÄ±ldÄ±
# - customers-api ve invoices-api kaldÄ±rÄ±ldÄ± (api'ye birleÅŸtirildi)
# - marketplace-api devre dÄ±ÅŸÄ± (ilk aÅŸamada gereksiz)
# - Traefik: Custom domain routing iÃ§in gerekli (multi-tenant)

services:
  # Tek PostgreSQL Database - TÃ¼m servisler aynÄ± DB'de farklÄ± schema'larda
  postgres:
    image: postgres:15-alpine
    container_name: tinisoft-postgres
    environment:
      POSTGRES_DB: tinisoft
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "127.0.0.1:5433:5432"  # Only accessible from localhost (5432 already in use)
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-schemas.sql:/docker-entrypoint-initdb.d/init-schemas.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tinisoft-network

  # Redis - Cache
  redis:
    image: redis:7-alpine
    ports:
      - "127.0.0.1:6380:6379"  # Only accessible from localhost
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tinisoft-network

  # RabbitMQ - Event Bus
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "127.0.0.1:5672:5672"  # Only accessible from localhost
      - "127.0.0.1:15672:15672"  # Only accessible from localhost
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tinisoft-network

  # Microservices
  products-api:
    build:
      context: .
      dockerfile: src/Tinisoft.Products.API/Dockerfile
    ports:
      - "127.0.0.1:5001:5001"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      RunMigrations: "true"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=products;Maximum Pool Size=50;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
      RabbitMQ__HostName: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      Redis__ConnectionString: "redis:6379"
      Jwt__SecretKey: ${JWT_SECRET_KEY:-TinisoftSuperSecretJWTKey2024Minimum32CharactersLongForSecurity!}
      Jwt__Issuer: tinisoft
      Jwt__Audience: tinisoft
      Jwt__ExpirationMinutes: 1440
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - tinisoft-network

  inventory-api:
    build:
      context: .
      dockerfile: src/Tinisoft.Inventory.API/Dockerfile
    ports:
      - "127.0.0.1:5002:5002"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      RunMigrations: "true"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=inventory;Maximum Pool Size=50;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
      RabbitMQ__HostName: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - tinisoft-network

  payments-api:
    build:
      context: .
      dockerfile: src/Tinisoft.Payments.API/Dockerfile
    ports:
      - "127.0.0.1:5003:5003"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      RunMigrations: "true"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=payments;Maximum Pool Size=50;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
      RabbitMQ__HostName: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      PayTR__MerchantId: 
      PayTR__MerchantKey: 
      PayTR__MerchantSalt: 
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - tinisoft-network

  orders-api:
    build:
      context: .
      dockerfile: src/Tinisoft.Orders.API/Dockerfile
    ports:
      - "127.0.0.1:5004:5004"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      RunMigrations: "true"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=orders;Maximum Pool Size=50;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
      RabbitMQ__HostName: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - tinisoft-network

  # marketplace-api: Ä°lk aÅŸamada devre dÄ±ÅŸÄ± (gereksiz)
  # marketplace-api:
  #   build:
  #     context: .
  #     dockerfile: src/Tinisoft.Marketplace.API/Dockerfile
  #   ports:
  #     - "127.0.0.1:5005:5005"
  #   environment:
  #     ASPNETCORE_ENVIRONMENT: Production
  #     RunMigrations: "true"
  #     ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=marketplace;Maximum Pool Size=50;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
  #     RabbitMQ__HostName: "rabbitmq"
  #     RabbitMQ__Port: "5672"
  #     RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
  #     RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #   networks:
  #     - tinisoft-network

  shipping-api:
    build:
      context: .
      dockerfile: src/Tinisoft.Shipping.API/Dockerfile
    ports:
      - "127.0.0.1:5007:5007"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      RunMigrations: "true"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=shipping;Maximum Pool Size=50;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
      RabbitMQ__HostName: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      Jwt__SecretKey: ${JWT_SECRET_KEY:-TinisoftSuperSecretJWTKey2024Minimum32CharactersLongForSecurity!}
      Jwt__Issuer: tinisoft
      Jwt__Audience: tinisoft
      Jwt__ExpirationMinutes: 1440
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - tinisoft-network

  notifications-api:
    build:
      context: .
      dockerfile: src/Tinisoft.Notifications.API/Dockerfile
    ports:
      - "127.0.0.1:5008:5008"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      RunMigrations: "true"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=notifications;Maximum Pool Size=50;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
      RabbitMQ__HostName: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      Jwt__SecretKey: ${JWT_SECRET_KEY:-TinisoftSuperSecretJWTKey2024Minimum32CharactersLongForSecurity!}
      Jwt__Issuer: tinisoft
      Jwt__Audience: tinisoft
      Jwt__ExpirationMinutes: 1440
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - tinisoft-network

  # Main API - customers ve invoices buraya birleÅŸtirildi
  api:
    build:
      context: .
      dockerfile: src/Tinisoft.API/Dockerfile
    ports:
      - "127.0.0.1:5010:5010"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      PORT: "5010"
      ASPNETCORE_HTTP_PORTS: "5010"
      RunMigrations: "true"
      SEED_DATABASE: "true"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=tinisoft;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};SearchPath=public;Maximum Pool Size=100;Command Timeout=30;Timeout=30;Connection Lifetime=0;Pooling=true;"
      Redis__ConnectionString: "redis:6379"
      RabbitMQ__HostName: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__UserName: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      Jwt__SecretKey: ${JWT_SECRET_KEY:-TinisoftSuperSecretJWTKey2024Minimum32CharactersLongForSecurity!}
      Jwt__Issuer: tinisoft
      Jwt__Audience: tinisoft
      Jwt__ExpirationMinutes: 1440
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - tinisoft-network

  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: src/Tinisoft.API.Gateway/Dockerfile
    ports:
      - "127.0.0.1:5000:5000"
    depends_on:
      - api
      - products-api
      - inventory-api
      - payments-api
      - orders-api
      - shipping-api
      - notifications-api
    networks:
      - tinisoft-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gateway.rule=Host(`localhost`) || Host(`api.tinisoft.com`) || HostRegexp(`{subdomain:[a-z0-9-]+}.domains.tinisoft.com`)"
      - "traefik.http.routers.gateway.entrypoints=web"
      - "traefik.http.services.gateway.loadbalancer.server.port=5000"

  # Traefik - Dynamic Domain Routing (Multi-tenant custom domain'ler iÃ§in)
  # Nginx ile Ã§akÄ±ÅŸmamasÄ± iÃ§in internal port'ta Ã§alÄ±ÅŸÄ±yor (3031)
  # Nginx â†’ Traefik:3031 â†’ Gateway
  traefik:
    image: traefik:v2.10
    container_name: tinisoft-traefik
    ports:
      - "127.0.0.1:3031:80"    # Internal - Sadece localhost (Nginx'ten eriÅŸilecek)
      - "127.0.0.1:3032:8080"  # Dashboard - Sadece localhost
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=tinisoft-network"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
      - "--accesslog=true"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/dynamic:/etc/traefik/dynamic:ro"
    networks:
      - tinisoft-network
    restart: unless-stopped
    depends_on:
      - gateway

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:

networks:
  tinisoft-network:
    driver: bridge
